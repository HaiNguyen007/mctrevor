<!DOCTYPE html><html lang="en"><head><title>client/js/app</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="client/js/app"><meta name="groc-project-path" content="client/js/app.coffee"><meta name="groc-github-url" content="https://github.com/killercup/mctrevor"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/killercup/mctrevor/blob/master/client/js/app.coffee">client/js/app.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="mc-trevor-frontend">MC Trevor Frontend</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper">jQuery <span class="function"><span class="params">($)</span> -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="dom">DOM</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  $loading = $(<span class="string">'#loading'</span>)
  $alerts = $(<span class="string">'#alerts'</span>)

  $pages = $(<span class="string">'#pages'</span>)
  $addPage = $(<span class="string">'#pages-add'</span>)

  $form = $(<span class="string">'#trevor'</span>)
  $pageFilename = $(<span class="string">'#page-filename'</span>)
  $pageTitle = $(<span class="string">'#page-title'</span>)
  $trevor = $(<span class="string">'#trevor-instance'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Trevor instance</p></div></div><div class="code"><div class="wrapper">  trevor = {}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><h2 id="current-page">Current Page</h2>
<p>Data Structure:</p>
<p>Example:</p>
<pre><code class="lang-json">{
    url: String,
    data: {
      title: String,
      content: Array
    }
}</code></pre></div></div><div class="code"><div class="wrapper">  currentPage = {}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="helpers">Helpers</h2>
<h3 id="reset-editor">Reset editor</h3></div></div><div class="code"><div class="wrapper">  <span class="function"><span class="title">editor</span> = -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Destroy previous instance</p></div></div><div class="code"><div class="wrapper">    trevor.destroy?()
    $trevor.empty()

    $pageTitle.val currentPage.data.title
    $pageFilename.text currentPage.url</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Let there be Trevor</p></div></div><div class="code"><div class="wrapper">    $trevor.val JSON.stringify <span class="attribute">data</span>: currentPage.data.content
    trevor = <span class="keyword">new</span> SirTrevor.Editor
      <span class="attribute">el</span>: $trevor
    $form.removeClass <span class="string">'hidden'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="add-an-alert">Add an alert</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="function"><span class="title">showAlert</span> = <span class="params">(content)</span> -&gt;</span>
    newAlert = $ content
    setTimeout (<span class="function">-&gt;</span> newAlert.remove()), <span class="number">2000</span>
    $alerts.prepend newAlert</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="load-pages">Load Pages</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="function"><span class="title">loadPages</span> = -&gt;</span>
    $.getJSON(<span class="string">"/pages"</span>)
    .success <span class="function"><span class="params">(data)</span> -&gt;</span>
      $pages.html data.pages.sort<span class="function"><span class="params">()</span>.<span class="title">map</span><span class="params">((page) -&gt;
        <span class="string">"&lt;a class='list-group-item' href='#' data-edit='<span class="subst">#{page}</span>'&gt;<span class="subst">#{page}</span>&lt;/a&gt;"</span>
      )</span>.<span class="title">join</span><span class="params">(<span class="string">''</span>)</span>
      <span class="title">$loading</span>.<span class="title">addClass</span> '<span class="title">hidden</span>'
</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="select-page">Select Page</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  $pages.<span class="literal">on</span> <span class="string">'click'</span>, <span class="string">'a[data-edit]'</span>, <span class="function"><span class="params">(event)</span> -&gt;</span>
    event.preventDefault()
    $pageLink = $(@)
    currentPage.url = $pageLink.data(<span class="string">'edit'</span>)
    $pageLink.siblings().removeClass <span class="string">'active'</span>
    $pageLink.addClass <span class="string">'active'</span>

    $.getJSON(<span class="string">"/pages<span class="subst">#{currentPage.url}</span>"</span>)
    .success <span class="function"><span class="params">(data)</span> -&gt;</span>
      currentPage.data = data
      editor()
    .fail <span class="function"><span class="params">(err)</span> -&gt;</span>
      window.alert(err)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="save-page">Save Page</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  $form.<span class="literal">on</span> <span class="string">'click'</span>, <span class="string">'a.save'</span>, <span class="function"><span class="params">(event)</span> -&gt;</span>
    event.preventDefault()
    <span class="keyword">return</span> <span class="keyword">unless</span> trevor? <span class="keyword">and</span> currentPage.data?

    newContent = trevor.blocks.map <span class="function"><span class="params">(i)</span> -&gt;</span> i.saveAndReturnData()

    currentPage.data.title = $pageTitle.val()
    currentPage.data.content = newContent

    $.ajax(
      <span class="attribute">type</span>: <span class="string">'POST'</span>
      <span class="attribute">url</span>: <span class="string">"/pages<span class="subst">#{currentPage.url}</span>"</span>
      <span class="attribute">contentType</span>: <span class="string">"application/json"</span>
      <span class="attribute">dataType</span>: <span class="string">"json"</span>
      <span class="attribute">data</span>: JSON.stringify currentPage.data
    )
    .success <span class="function"><span class="params">(res)</span> -&gt;</span>
      showAlert <span class="string">"&lt;div class='alert alert-success'&gt;Saved &lt;em&gt;<span class="subst">#{currentPage.url}</span>&lt;/em&gt;&lt;/div&gt;"</span>
      <span class="keyword">if</span> currentPage._new
        loadPages()
    .fail <span class="function"><span class="params">(err)</span> -&gt;</span>
      console.error err
      showAlert <span class="string">"&lt;div class='alert alert-danger'&gt;Failed to save &lt;em&gt;<span class="subst">#{currentPage.url}</span>&lt;/em&gt;!&lt;/div&gt;"</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="add-page">Add Page</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  $addPage.<span class="literal">on</span> <span class="string">'submit'</span>, <span class="function"><span class="params">(event)</span> -&gt;</span>
    event.preventDefault()
    filename = $(<span class="string">'#pages-add-title'</span>).val()
    currentPage =
      <span class="attribute">_new</span>: <span class="literal">true</span>
      <span class="attribute">url</span>: filename
      <span class="attribute">data</span>:
        <span class="attribute">title</span>: <span class="string">''</span>
        <span class="attribute">content</span>: []
    editor()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="init">Init</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  loadPages()</div></div></div></div></body></html>